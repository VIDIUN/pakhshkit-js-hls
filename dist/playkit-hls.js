!function(e,r){"object"==typeof exports&&"object"==typeof module?module.exports=r(require("playkit-js"),require("hls.js")):"function"==typeof define&&define.amd?define(["playkit-js","hls.js"],r):"object"==typeof exports?exports.hls=r(require("playkit-js"),require("hls.js")):(e.playkit=e.playkit||{},e.playkit.hls=r(e.playkit.core,e.Hls))}(this,function(e,r){return function(e){function r(o){if(t[o])return t[o].exports;var a=t[o]={i:o,l:!1,exports:{}};return e[o].call(a.exports,a,a.exports,r),a.l=!0,a.exports}var t={};return r.m=e,r.c=t,r.d=function(e,t,o){r.o(e,t)||Object.defineProperty(e,t,{configurable:!1,enumerable:!0,get:o})},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,r){return Object.prototype.hasOwnProperty.call(e,r)},r.p="",r(r.s=2)}([function(r,t){r.exports=e},function(e,t){e.exports=r},function(e,r,t){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.NAME=r.VERSION=void 0;var o=t(0),a=t(3),i=function(e){return e&&e.__esModule?e:{default:e}}(a);r.default=i.default,r.VERSION="1.5.5",r.NAME="playkit-js-hls",i.default.isSupported()&&(0,o.registerMediaSourceAdapter)(i.default)},function(e,r,t){"use strict";function o(e){return e&&e.__esModule?e:{default:e}}function a(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}function i(e,r){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!r||"object"!=typeof r&&"function"!=typeof r?e:r}function n(e,r){if("function"!=typeof r&&null!==r)throw new TypeError("Super expression must either be null or a function, not "+typeof r);e.prototype=Object.create(r&&r.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),r&&(Object.setPrototypeOf?Object.setPrototypeOf(e,r):e.__proto__=r)}Object.defineProperty(r,"__esModule",{value:!0});var s=function e(r,t,o){null===r&&(r=Function.prototype);var a=Object.getOwnPropertyDescriptor(r,t);if(void 0===a){var i=Object.getPrototypeOf(r);return null===i?void 0:e(i,t,o)}if("value"in a)return a.value;var n=a.get;if(void 0!==n)return n.call(o)},l=function(){function e(e,r){for(var t=0;t<r.length;t++){var o=r[t];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(r,t,o){return t&&e(r.prototype,t),o&&e(r,o),r}}(),d=t(1),c=o(d),u=t(4),_=o(u),h=t(5),E=t(0),v=function(e){function r(e,t,o){a(this,r),r._logger.debug("Creating adapter. Hls version: "+c.default.version);var n=i(this,(r.__proto__||Object.getPrototypeOf(r)).call(this,e,t,o));return n._config=E.Utils.Object.mergeDeep({},n._config,_.default),n._hls=new c.default(n._config),n._addBindings(),n}return n(r,e),l(r,null,[{key:"createAdapter",value:function(e,r,t){var o={};return E.Utils.Object.hasPropertyPath(t,"playback.options.html5.hls")&&(o=t.playback.options.html5.hls),new this(e,r,o)}},{key:"canPlayType",value:function(e){var t="string"==typeof e&&r._hlsMimeTypes.includes(e.toLowerCase());return r._logger.debug("canPlayType result for mimeType:"+e+" is "+t.toString()),t}},{key:"canPlayDrm",value:function(){return r._logger.warn("canPlayDrm result is false"),!1}},{key:"isSupported",value:function(){var e=c.default.isSupported();return r._logger.debug("isSupported:"+e),e}}]),l(r,[{key:"_addBindings",value:function(){var e=this;this._hls.on(c.default.Events.ERROR,function(r,t){e._onError(t)}),this._hls.on(c.default.Events.MANIFEST_LOADED,this._onManifestLoaded.bind(this)),this._hls.on(c.default.Events.LEVEL_SWITCHED,this._onLevelSwitched.bind(this)),this._hls.on(c.default.Events.AUDIO_TRACK_SWITCHED,this._onAudioTrackSwitched.bind(this))}},{key:"load",value:function(e){var r=this;return this._loadPromise||(this._loadPromise=new Promise(function(t){r._onLoadedMetadataCallback=r._onLoadedMetadata.bind(r,t),r._videoElement.addEventListener(E.EventType.LOADED_METADATA,r._onLoadedMetadataCallback),e&&(r._hls.startPosition=e),r._sourceObj&&r._sourceObj.url&&(r._hls.loadSource(r._sourceObj.url),r._hls.attachMedia(r._videoElement),r._trigger(E.EventType.ABR_MODE_CHANGED,{mode:r.isAdaptiveBitrateEnabled()?"auto":"manual"}))})),this._loadPromise}},{key:"_onLoadedMetadata",value:function(e){this._removeLoadedMetadataListener(),e({tracks:this._playerTracks})}},{key:"_removeLoadedMetadataListener",value:function(){this._onLoadedMetadataCallback&&(this._videoElement.removeEventListener(E.EventType.LOADED_METADATA,this._onLoadedMetadataCallback),this._onLoadedMetadataCallback=null)}},{key:"destroy",value:function(){var e=this;return s(r.prototype.__proto__||Object.getPrototypeOf(r.prototype),"destroy",this).call(this).then(function(){r._logger.debug("destroy"),e._loadPromise=null,e._playerTracks=[],e._removeBindings(),e._hls.detachMedia(),e._hls.destroy()})}},{key:"_parseTracks",value:function(){var e=this._parseAudioTracks(this._hls.audioTracks||[]),r=this._parseVideoTracks(this._hls.levels||[]),t=this._parseTextTracks(this._hls.subtitleTracks||[]);return e.concat(r).concat(t)}},{key:"_parseAudioTracks",value:function(e){for(var r=[],t=0;t<e.length;t++){var o={id:e[t].id,active:this._hls.audioTrack===e[t].id,label:e[t].name,language:e[t].lang,index:t};r.push(new E.AudioTrack(o))}return r}},{key:"_parseVideoTracks",value:function(e){for(var r=[],t=0;t<e.length;t++){var o={active:this._hls.startLevel===t,label:e[t].name,bandwidth:e[t].bitrate,width:e[t].width,height:e[t].height,language:"",index:t};r.push(new E.VideoTrack(o))}return r}},{key:"_parseTextTracks",value:function(e){for(var r=[],t=0;t<e.length;t++){var o={id:e[t].id,active:e[t].default,label:e[t].name,kind:e[t].type.toLowerCase(),language:e[t].lang,index:t};r.push(new E.TextTrack(o))}return r}},{key:"selectAudioTrack",value:function(e){e instanceof E.AudioTrack&&!e.active&&this._hls.audioTracks&&(this._hls.audioTrack=e.id)}},{key:"selectVideoTrack",value:function(e){e instanceof E.VideoTrack&&(!e.active||this.isAdaptiveBitrateEnabled())&&this._hls.levels&&(this.isAdaptiveBitrateEnabled()&&this._trigger(E.EventType.ABR_MODE_CHANGED,{mode:"manual"}),this._hls.currentLevel=e.index)}},{key:"selectTextTrack",value:function(e){e instanceof E.TextTrack&&!e.active&&this._videoElement.textTracks&&(this._disableAllTextTracks(),this._videoElement.textTracks[e.index].mode="hidden",r._logger.debug("Text track changed",e),this._onTrackChanged(e))}},{key:"hideTextTrack",value:function(){this._disableAllTextTracks()}},{key:"enableAdaptiveBitrate",value:function(){this.isAdaptiveBitrateEnabled()||(this._trigger(E.EventType.ABR_MODE_CHANGED,{mode:"auto"}),this._hls.nextLevel=-1)}},{key:"isAdaptiveBitrateEnabled",value:function(){return this._hls.autoLevelEnabled}},{key:"_getLevelDetails",value:function(){var e=this._hls.levels[this._hls.currentLevel]||this._hls.levels[this._hls.nextLevel]||this._hls.levels[this._hls.nextAutoLevel]||this._hls.levels[this._hls.nextLoadLevel];return e&&e.details?e.details:{}}},{key:"_getLiveEdge",value:function(){try{var e=void 0;return e=this._hls.liveSyncPosition?this._hls.liveSyncPosition:this._hls.config.liveSyncDuration?this._videoElement.duration-this._hls.config.liveSyncDuration:this._videoElement.duration-this._hls.config.liveSyncDurationCount*this._getLevelDetails().targetduration,e>0?e:this._videoElement.duration}catch(e){return r._logger.debug("Live edge calculation failed, fall back to duration"),this._videoElement.duration}}},{key:"seekToLiveEdge",value:function(){try{this._videoElement.currentTime=this._getLiveEdge()}catch(e){return}}},{key:"isLive",value:function(){try{return this._getLevelDetails().live}catch(e){return!1}}},{key:"_onManifestLoaded",value:function(){r._logger.debug("The source has been loaded successfully"),this._hls.startLoad(),this._playerTracks=this._parseTracks()}},{key:"_onLevelSwitched",value:function(e,t){var o=this._playerTracks.find(function(e){return e instanceof E.VideoTrack&&e.index===t.level});r._logger.debug("Video track changed",o),this._onTrackChanged(o)}},{key:"_onAudioTrackSwitched",value:function(e,t){var o=this._playerTracks.find(function(e){return e instanceof E.AudioTrack&&e.id===t.id});r._logger.debug("Audio track changed",o),this._onTrackChanged(o),this._handleWaitingUponAudioTrackSwitch()}},{key:"_handleWaitingUponAudioTrackSwitch",value:function(){var e=this;if(["IE","Edge"].includes(E.Env.browser.name)){var r=function r(){e._trigger(E.EventType.PLAYING),e._videoElement.removeEventListener(E.EventType.TIME_UPDATE,r)};this._videoElement.addEventListener(E.EventType.TIME_UPDATE,r)}}},{key:"_disableAllTextTracks",value:function(){for(var e=this._videoElement.textTracks,r=0;r<e.length;r++)e[r].mode="disabled"}},{key:"_onError",value:function(e){var t=e.type,o=e.details;if(e.fatal){var a=void 0;switch(t){case c.default.ErrorTypes.NETWORK_ERROR:a=new E.Error(E.Error.Severity.CRITICAL,E.Error.Category.NETWORK,E.Error.Code.HTTP_ERROR,o);break;case c.default.ErrorTypes.MEDIA_ERROR:a=this._handleMediaError()?new E.Error(E.Error.Severity.RECOVERABLE,E.Error.Category.MEDIA,E.Error.Code.HLS_FATAL_MEDIA_ERROR,o):new E.Error(E.Error.Severity.CRITICAL,E.Error.Category.MEDIA,E.Error.Code.HLS_FATAL_MEDIA_ERROR,o);break;default:a=new E.Error(E.Error.Severity.CRITICAL,E.Error.Category.PLAYER,E.Error.Code.HLS_FATAL_MEDIA_ERROR,o)}this._trigger(E.EventType.ERROR,a),a&&a.severity===E.Error.Severity.CRITICAL&&this.destroy()}else{var i=h.HlsJsErrorMap[o]||{category:0,code:0},n=i.category,s=i.code;r._logger.warn(new E.Error(E.Error.Severity.RECOVERABLE,n,s,o))}}},{key:"_handleMediaError",value:function(){var e=performance.now(),t=!0;return this._checkTimeDeltaHasPassed(e,this._recoverDecodingErrorDate,this._config.recoverDecodingErrorDelay)?this._recoverDecodingError():this._checkTimeDeltaHasPassed(e,this._recoverSwapAudioCodecDate,this._config.recoverSwapAudioCodecDelay)?this._recoverSwapAudioCodec():(t=!1,r._logger.error("cannot recover, last media error recovery failed")),t}},{key:"_checkTimeDeltaHasPassed",value:function(e,r,t){return!r||e-r>t}},{key:"_recoverDecodingError",value:function(){this._recoverDecodingErrorDate=performance.now(),r._logger.warn("try to recover media Error"),this._hls.recoverMediaError()}},{key:"_recoverSwapAudioCodec",value:function(){this._recoverSwapAudioCodecDate=performance.now(),r._logger.warn("try to swap Audio Codec and recover media Error"),this._hls.swapAudioCodec(),this._hls.recoverMediaError()}},{key:"_removeBindings",value:function(){this._hls.off(c.default.Events.ERROR,this._onError),this._hls.off(c.default.Events.LEVEL_SWITCHED,this._onLevelSwitched),this._hls.off(c.default.Events.AUDIO_TRACK_SWITCHED,this._onAudioTrackSwitched),this._removeLoadedMetadataListener()}},{key:"getStartTimeOfDvrWindow",value:function(){if(!this.isLive())return 0;try{var e=this._hls.levels[this._hls.nextLoadLevel],t=e.details,o=t.fragments,a=o.length,i=o[0].start+o[0].duration,n=o[a-1].start+o[a-1].duration,s=void 0!==this._hls.config.liveMaxLatencyDuration?this._hls.config.liveMaxLatencyDuration:this._hls.config.liveMaxLatencyDurationCount*t.targetduration;return Math.max(i-this._hls.config.maxFragLookUpTolerance,n-s)}catch(e){return r._logger.debug("Unable obtain the start of DVR window"),0}}},{key:"src",get:function(){return this._loadPromise&&this._sourceObj?this._sourceObj.url:""}}]),r}(E.BaseMediaSourceAdapter);v.id="HlsAdapter",v._logger=E.BaseMediaSourceAdapter.getLogger(v.id),v._hlsMimeTypes=["application/x-mpegurl","application/vnd.apple.mpegurl","audio/mpegurl","audio/x-mpegurl","video/x-mpegurl","video/mpegurl","application/mpegurl"],r.default=v},function(e,r){e.exports={recoverDecodingErrorDelay:3e3,recoverSwapAudioCodecDelay:3e3,fragLoadingMaxRetry:4,maxMaxBufferLength:60}},function(e,r,t){"use strict";function o(e,r,t){return r in e?Object.defineProperty(e,r,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[r]=t,e}Object.defineProperty(r,"__esModule",{value:!0}),r.HlsJsErrorMap=void 0;var a,i=t(1),n=function(e){return e&&e.__esModule?e:{default:e}}(i),s=t(0),l=(a={},o(a,n.default.ErrorDetails.MANIFEST_LOAD_ERROR,{category:s.Error.Category.MANIFEST,code:s.Error.Code.HTTP_ERROR}),o(a,n.default.ErrorDetails.MANIFEST_LOAD_TIMEOUT,{category:s.Error.Category.MANIFEST,code:s.Error.Code.TIMEOUT}),o(a,n.default.ErrorDetails.MANIFEST_PARSING_ERROR,{category:s.Error.Category.MANIFEST,code:s.Error.Code.HLSJS_CANNOT_PARSE}),o(a,n.default.ErrorDetails.LEVEL_LOAD_ERROR,{category:s.Error.Category.NETWORK,code:s.Error.Code.HTTP_ERROR}),o(a,n.default.ErrorDetails.LEVEL_LOAD_TIMEOUT,{category:s.Error.Category.NETWORK,code:s.Error.Code.TIMEOUT}),o(a,n.default.ErrorDetails.LEVEL_SWITCH_ERROR,{category:s.Error.Category.PLAYER,code:s.Error.Code.BITRATE_SWITCH_ISSUE}),o(a,n.default.ErrorDetails.FRAG_LOAD_ERROR,{category:s.Error.Category.NETWORK,code:s.Error.Code.HTTP_ERROR}),o(a,n.default.ErrorDetails.FRAG_LOOP_LOADING_ERROR,{category:s.Error.Category.NETWORK,code:s.Error.Code.HTTP_ERROR}),o(a,n.default.ErrorDetails.FRAG_LOAD_TIMEOUT,{category:s.Error.Category.NETWORK,code:s.Error.Code.TIMEOUT}),o(a,n.default.ErrorDetails.FRAG_PARSING_ERROR,{category:s.Error.Category.MEDIA,code:s.Error.Code.HLS_FRAG_PARSING_ERROR}),o(a,n.default.ErrorDetails.BUFFER_APPEND_ERROR,{category:s.Error.Category.MEDIA,code:s.Error.Code.HLS_BUFFER_APPEND_ISSUE}),o(a,n.default.ErrorDetails.BUFFER_APPENDING_ERROR,{category:s.Error.Category.MEDIA,code:s.Error.Code.HLS_BUFFER_APPENDING_ISSUE}),o(a,n.default.ErrorDetails.BUFFER_STALLED_ERROR,{category:s.Error.Category.MEDIA,code:s.Error.Code.HLS_BUFFER_STALLED_ERROR}),a);r.HlsJsErrorMap=l}])});
//# sourceMappingURL=playkit-hls.js.map